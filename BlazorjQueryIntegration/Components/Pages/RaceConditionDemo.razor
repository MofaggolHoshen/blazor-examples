@page "/race-condition-demo"
@rendermode InteractiveServer
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Race Condition Demo</PageTitle>

<div class="container mt-4">
    <h2>Race Condition Demo: Delete Operation</h2>
    <p class="text-muted">Click delete buttons rapidly to trigger race condition</p>

    <!-- Add new item -->
    <div class="mb-3">
        <div class="input-group" style="max-width: 400px;">
            <input type="text" class="form-control" @bind="newName" placeholder="Enter name" />
            <button class="btn btn-primary" @onclick="AddItem">Add Item</button>
        </div>
    </div>

    @foreach(var item in items)
    {
        var id = $"item-{item.Id}";

        <div id=@id class="d-flex justify-content-between align-items-center mb-2" style="max-width: 400px;">
            <span>@item.Name</span>
            <button class="btn btn-danger btn-sm" @onclick="() => DeleteItem(item.Id)">
                Delete
            </button>
        </div>
    }
</div>

@code {
    private IJSObjectReference? jsModule;
    private List<DataItem> items = new();
    private string newName = "";
    private int nextId = 1;

    protected override void OnInitialized()
    {
        // Initialize with 5 items
        items = new List<DataItem>
        {
            new DataItem { Id = 1, Name = "John Doe" },
            new DataItem { Id = nextId++, Name = "Jane Smith" },
            new DataItem { Id = nextId++, Name = "Bob Johnson" },
            new DataItem { Id = nextId++, Name = "Alice Brown" },
            new DataItem { Id = nextId++, Name = "Charlie Wilson" }
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsModule = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./Components/Pages/RaceConditionDemo.razor.js");
        }
    }


    private void AddItem()
    {
        if (string.IsNullOrWhiteSpace(newName)) return;

        items.Add(new DataItem { Id = nextId++, Name = newName });
        newName = "";
    }

    // ❌ This causes race condition!
    private async Task DeleteItem(int id)
    {
            // Remove item from list
            items.RemoveAll(x => x.Id == id);

            // ❌ RACE CONDITION: StateHasChanged then immediately refresh DataTable
            StateHasChanged();  // Queues render, doesn't wait!

            // DataTable refresh runs while Blazor updates DOM → CONFLICT!
            if (jsModule != null)
            {
                await jsModule.InvokeVoidAsync("deteleteElement", $"item-{id}");
            }

        // ❌ RACE CONDITION: Still queues another render after JS call, which may cause another conflict if user clicks rapidly
        //StateHasChanged();  // Queues render, doesn't wait!

    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (jsModule != null)
        {
            try { await jsModule.DisposeAsync(); }
            catch (JSDisconnectedException) { }
        }
    }

    private class DataItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
    }
}

