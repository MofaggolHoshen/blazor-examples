@page "/datatable-example"
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject IDataService DataService
@implements IAsyncDisposable

<PageTitle>DataTables Example</PageTitle>

<h1>jQuery DataTables Integration</h1>

<div class="container mt-4">
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="InitializeDataTable">Initialize DataTable</button>
        <button class="btn btn-success" @onclick="AddRandomPerson">Add Random Person</button>
        <button class="btn btn-danger" @onclick="ClearTable">Clear Table</button>
    </div>
    
    <table id="peopleTable" class="table table-striped" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Age</th>
                <th>City</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var person in people)
            {
                <tr>
                    <td>@person.Id</td>
                    <td>@person.Name</td>
                    <td>@person.Email</td>
                    <td>@person.Age</td>
                    <td>@person.City</td>
                </tr>
            }
        </tbody>
    </table>
    
    <p class="mt-3">Total Records: <strong>@people.Count</strong></p>
</div>

@code {
    private List<Person> people = new();
    private Random random = new();
    private IJSObjectReference? jsModule;

    protected override async Task OnInitializedAsync()
    {
        people = await DataService.GetAllPersonsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/Pages/DataTableExample.razor.js");
        }
    }

    private async Task InitializeDataTable()
    {
        if (jsModule != null)
        {
            await jsModule.InvokeVoidAsync("initialize");
        }
    }

    private async Task AddRandomPerson()
    {
        var names = new[] { "Michael", "Sarah", "David", "Emma", "James", "Olivia", "Robert", "Sophia" };
        var lastNames = new[] { "Anderson", "Taylor", "Moore", "Jackson", "White", "Harris", "Martin", "Garcia" };
        var cities = new[] { "Boston", "Seattle", "Miami", "Denver", "Austin", "Portland", "Atlanta", "Nashville" };
        
        var newPerson = new Person
        {
            Name = $"{names[random.Next(names.Length)]} {lastNames[random.Next(lastNames.Length)]}",
            Email = $"user{random.Next(1000, 9999)}@example.com",
            Age = random.Next(20, 60),
            City = cities[random.Next(cities.Length)]
        };

        await DataService.AddPersonAsync(newPerson);
        people = await DataService.GetAllPersonsAsync();
        StateHasChanged();

        if (jsModule != null)
        {
            await jsModule.InvokeVoidAsync("refresh");
        }
    }

    private async Task ClearTable()
    {
        await DataService.ClearAllPersonsAsync();
        people = await DataService.GetAllPersonsAsync();
        StateHasChanged();
      
        if (jsModule != null)
        {
            await jsModule.InvokeVoidAsync("refresh");
        }

       
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Ignore - the circuit has already disconnected
            }
        }
    }
}
